{% extends 'metrics/base.html' %}
{% block pagetitle %}Backlog Metrics{% endblock %}
{% block title %}
<div class="row">
  <div class="col-sm-2"></div>
  <div class="col-sm-8 text-center"><h2>{{ header }}</h2></div>
  <div class="col-sm-2"></div>
</div>
{% endblock %}
{% block js %}
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

      // Load the Visualization API and the corechart package.
      google.charts.load('current', {'packages':['corechart']});

      // Set a callback to run when the Google Visualization API is loaded.
      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
          var djangoData = JSON.parse('{{ theme|safe }}');
          drawThisChart(djangoData, 'theme');

          djangoData = JSON.parse('{{ size|safe }}');
          drawThisChart(djangoData, 'size');

          djangoData = JSON.parse('{{ track|safe }}');
          drawThisChart(djangoData, 'track');

          djangoData = JSON.parse('{{ module|safe }}');
          drawThisChart(djangoData, 'module');
      }
      function drawThisChart(djangoData, chartType) {
          var data = new google.visualization.DataTable();
          data.addColumn('string','Metric');
          data.addColumn('number','Story Count');
          var chartTitle = "{{ title }}";

          if (djangoData.length == 0) {
              document.getElementById('piechart').innerHTML = "Something went wrong, no data passed in.";
          } else {
              for (var i=0;i<djangoData.length;i++) {
                 data.addRows([[djangoData[i].metric,djangoData[i].scount]]);
              } 
          }
          
          chartTitle = chartTitle + chartType;
          console.log(chartTitle);
          var options = {
             titleTextStyle: {fontSize:20},
             title: chartTitle,
          };

          var chart = new google.visualization.PieChart(document.getElementById(chartType));
          chart.draw(data, options);
          google.visualization.events.addListener(chart, 'select', function () {selectHandler(chart,data,chartType)});

          function resizeHandler() {
              chart.draw(data, options);
          }
          if (window.addEventListener) {
              window.addEventListener('resize', resizeHandler, false);
          }
          else if (window.attachEvent) {
              window.attachEvent('onresize', resizeHandler);
          }
      }
      function selectHandler(metaChart,metaData,option) {
          var selection = metaChart.getSelection();
             if (selection.length) {
                 var pieSliceLabel = metaData.getValue(selection[0].row,0);
                 post(option, pieSliceLabel)
          }
      }
      function post(tag, value) {
             var form = document.createElement("form");
             form.setAttribute("method", "post");
             form.setAttribute("action", "{% url 'backlog' %}");
             var hiddenField = document.createElement("input");
             var hiddenField2 = document.createElement("input");
             hiddenField.setAttribute("type", "hidden");
             hiddenField.setAttribute("name", tag);
             hiddenField.setAttribute("value", value);
             form.appendChild(hiddenField);
             hiddenField2.setAttribute("type", "hidden");
             hiddenField2.setAttribute("name", "csrfmiddlewaretoken");
             hiddenField2.setAttribute("value", "{{csrf_token}}");
             form.appendChild(hiddenField2);
             document.body.appendChild(form);
             form.submit();
      }
      $(window).resize(function(){
          drawChart();
      }); 
    </script>
{% endblock %}
{% block primary %}
  <div class="row">
    <div class="col-sm-2"></div>
    <div class="col-sm-4">
      <div id="theme" class="chart"></div>
    </div>
    <div class="col-sm-4">
      <div id="size" class="chart"></div>
    </div>
    <div class="col-sm-2"></div>
  </div>
  <div class="row">
    <div class="col-sm-2"></div>
    <div class="col-sm-4">
      <div id="track" class="chart"></div>
    </div>
    <div class="col-sm-4">
      <div id="module" class="chart"></div>
    </div>
    <div class="col-sm-2"></div>
  </div>
{% endblock %}
